name: CD - Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-snapshot:
    name: Build SNAPSHOT Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      snapshot-version: ${{ steps.version.outputs.snapshot-version }}
      is-release: ${{ steps.version.outputs.is-release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          # Read base version from VERSION file
          if [ -f VERSION ]; then
            BASE_VERSION=$(cat VERSION)
          else
            BASE_VERSION="1.0.0"
          fi
          
          # Check if this is a release commit (no -SNAPSHOT in VERSION file)
          if [[ "$BASE_VERSION" == *"-SNAPSHOT"* ]]; then
            IS_RELEASE="false"
            # Generate timestamp for SNAPSHOT build
            TIMESTAMP=$(date -u +"%Y%m%d.%H%M%S")
            SNAPSHOT_VERSION="${BASE_VERSION/-SNAPSHOT/}-SNAPSHOT-${TIMESTAMP}"
          else
            IS_RELEASE="true"
            SNAPSHOT_VERSION="${BASE_VERSION}"
          fi
          
          echo "snapshot-version=${SNAPSHOT_VERSION}" >> $GITHUB_OUTPUT
          echo "is-release=${IS_RELEASE}" >> $GITHUB_OUTPUT
          echo "Building version: ${SNAPSHOT_VERSION}"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Create distribution package
        run: |
          mkdir -p dist
          
          # Create version info file
          echo "${{ steps.version.outputs.snapshot-version }}" > dist/VERSION
          
          # Copy necessary files
          cp prototype.py dist/
          cp requirements.txt dist/
          cp README.md dist/ || echo "README will be auto-generated"
          
          # Create installation script
          cat > dist/install.sh << 'EOF'
          #!/bin/bash
          echo "Installing README Auto-Generator..."
          pip install -r requirements.txt
          echo "Installation complete!"
          echo "Usage: python prototype.py"
          EOF
          chmod +x dist/install.sh
          
          # Create user guide
          cat > dist/USER_GUIDE.md << 'EOF'
          # README Auto-Generator - User Guide
          
          ## Installation
          
          ### Option 1: GitHub Actions (Recommended)
          
          1. Copy the workflow file to your repository:
          ```bash
          mkdir -p .github/workflows
          # Copy update-readme.yml to .github/workflows/
          ```
          
          2. Add required files:
          ```bash
          # Copy prototype.py and requirements.txt to your repo root
          ```
          
          3. Set up your OpenAI API key:
             - Go to Settings â†’ Secrets and variables â†’ Actions
             - Add secret: `OPENAI_API_KEY`
          
          4. Push to main branch - your README will auto-update!
          
          ### Option 2: Local Installation
          
          ```bash
          bash install.sh
          export OPENAI_API_KEY="your-api-key"
          python prototype.py
          ```
          
          ## Configuration
          
          Edit `prototype.py` to customize:
          - README template
          - Commit analysis depth
          - Output format
          
          ## Troubleshooting
          
          - **No changes detected**: Make sure you have commits in your repository
          - **API errors**: Verify your OPENAI_API_KEY is set correctly
          - **Permission errors**: Ensure GitHub Actions has write permissions
          EOF
          
          # Create a tarball for distribution
          tar -czf readme-generator-${{ steps.version.outputs.snapshot-version }}.tar.gz -C dist .
          
          # Create a zip for Windows users
          cd dist && zip -r ../readme-generator-${{ steps.version.outputs.snapshot-version }}.zip . && cd ..

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: readme-generator-${{ steps.version.outputs.snapshot-version }}
          path: |
            readme-generator-*.tar.gz
            readme-generator-*.zip
          retention-days: 90

      - name: Create/Update SNAPSHOT Release
        if: steps.version.outputs.is-release == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.snapshot-version }}"
          
          # Delete existing SNAPSHOT release if it exists
          gh release delete SNAPSHOT --yes 2>/dev/null || true
          
          # Create new SNAPSHOT release
          gh release create SNAPSHOT \
            --title "SNAPSHOT Build, Latest Development Version" \
            --notes "## SNAPSHOT Build - ${VERSION}
          
          This is a **bleeding-edge** development build containing the latest features, enhancements, and bug fixes.
          
          **Not recommended for production use.** This build may be unstable or contain incomplete features.
          
          ### ðŸ“¦ Download
          - **Linux/Mac**: \`readme-generator-${VERSION}.tar.gz\`
          - **Windows**: \`readme-generator-${VERSION}.zip\`
          
          ### ðŸ”§ Installation
          \`\`\`bash
          # Extract the archive
          tar -xzf readme-generator-${VERSION}.tar.gz
          cd dist
          bash install.sh
          \`\`\`
          
          ### What's New
          This build includes all changes up to commit \`${GITHUB_SHA:0:7}\`.
          
          See the [commit history](https://github.com/${{ github.repository }}/commits/main) for details.
          

      - name: Create Stable Release
        if: steps.version.outputs.is-release == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.snapshot-version }}"
          
          # Check if this version already exists
          if gh release view "v${VERSION}" >/dev/null 2>&1; then
            echo "Release v${VERSION} already exists. Skipping."
            exit 0
          fi
          
          # Create stable release
          gh release create "v${VERSION}" \
            --title "Release v${VERSION}" \
            --notes "## Release v${VERSION}
          
          This is a **stable release** of the README Auto-Generator.
          
          ### Download
          - **Linux/Mac**: \`readme-generator-${VERSION}.tar.gz\`
          - **Windows**: \`readme-generator-${VERSION}.zip\`
          
          ### Quick Start
          \`\`\`bash
          # Download and extract
          tar -xzf readme-generator-${VERSION}.tar.gz
          cd dist
          
          # Install
          bash install.sh
          
          # Run
          export OPENAI_API_KEY='your-key'
          python prototype.py
          \`\`\`
          
          ### Documentation
          See \`USER_GUIDE.md\` in the package for complete documentation.
          
          ### GitHub Actions Integration
          Add to your \`.github/workflows/update-readme.yml\`:
          \`\`\`yaml
          - uses: actions/checkout@v4
          - uses: actions/setup-python@v4
          - run: |
              pip install -r requirements.txt
              python prototype.py
          \`\`\`
          
          ### Bug Reports
          Found an issue? [Open an issue](https://github.com/${{ github.repository }}/issues)" \
            readme-generator-${VERSION}.tar.gz \
            readme-generator-${VERSION}.zip

  summary:
    name: Deployment Summary
    needs: [build-snapshot]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "## Continuous Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.build-snapshot.outputs.snapshot-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ needs.build-snapshot.outputs.is-release == 'true' && 'Stable Release' || 'SNAPSHOT Build' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- **Live Demo**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Releases**: https://github.com/${{ github.repository }}/releases" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest SNAPSHOT**: https://github.com/${{ github.repository }}/releases/tag/SNAPSHOT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Download latest build" >> $GITHUB_STEP_SUMMARY
          echo "wget https://github.com/${{ github.repository }}/releases/download/SNAPSHOT/readme-generator-${{ needs.build-snapshot.outputs.snapshot-version }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY